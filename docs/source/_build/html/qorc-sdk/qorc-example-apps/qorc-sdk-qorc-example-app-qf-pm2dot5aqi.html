

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Building the pm2dot5aqi app &mdash; QORC-SDK  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="QuickLogic FPGA Toolchain" href="../../ql-symbiflow/ql-symbiflow.html" />
    <link rel="prev" title="QORC Example Applications" href="qorc-example-apps.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/qorc_whitebg.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../qorc-setup/qorc-setup.html">Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../qorc-sdk.html">QORC-SDK</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-hal/qorc-sdk-hal.html">QORC-SDK HAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-libraries/qorc-sdk-libraries.html">QORC-SDK Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-s3-gateware/qorc-sdk-s3-gateware.html">QORC-SDK EOS S3 FPGA Designs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-qf-apps/qorc-sdk-qf-apps.html">QuickFeather Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-qf-vr-apps/qorc-sdk-qf-vr-apps.html">QORC Voice Recognition apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qorc-sdk-qorc-test-apps/qorc-sdk-qorc-test-apps.html">QORC Test Applications</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="qorc-example-apps.html">QORC Example Applications</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="qorc-example-apps.html#list-of-apps">List of apps</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Building the pm2dot5aqi app</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ql-symbiflow/ql-symbiflow.html">QuickLogic FPGA Toolchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ql-development-boards/ql-development-boards.html">QuickLogic Development Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ql-eos-s3/ql-eos-s3.html">QuickLogic EOS S3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ql-faq/ql-faq.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QORC-SDK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../qorc-sdk.html">QORC-SDK</a> &raquo;</li>
        
          <li><a href="qorc-example-apps.html">QORC Example Applications</a> &raquo;</li>
        
      <li>Building the pm2dot5aqi app</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/qorc-sdk/qorc-example-apps/qorc-sdk-qorc-example-app-qf-pm2dot5aqi.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-the-pm2dot5aqi-app">
<h1>Building the pm2dot5aqi app<a class="headerlink" href="#building-the-pm2dot5aqi-app" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p>With the fires raging in California, air quality is a concern. So I
thought that it would be fun to create a small app using QuickFeather to
monitor the local air quality. This document captures the steps that I
went through to create a device that monitors the PM2.5 level, and uses
the LED to indicate whether the level is considered, Good, Moderate or
Unhealthy.</p>
</div>
<div class="section" id="sensor-connections">
<h2>Sensor connections<a class="headerlink" href="#sensor-connections" title="Permalink to this headline">¶</a></h2>
<p>Adafruit has a nifty PM2.5 sensor: <img alt="qf_pm2dot5aqi PMS5003" src="../../_images/qf_pm2dot5aqi-PMS5003.png" /></p>
<p>The datasheet lets us know the device uses a UART interface with pinout:
<img alt="qf_pm2dot5aqi PMS5003-pinout" src="../../_images/qf_pm2dot5aqi-PMS5003-pinout.png" /></p>
<p>While the datasheet indicates that we can leave SET and RESET
unconnected, to get maximum flexibility we will connect them to GPIO so
that we can control them.</p>
</div>
<div class="section" id="quickfeather-connections">
<h2>QuickFeather connections<a class="headerlink" href="#quickfeather-connections" title="Permalink to this headline">¶</a></h2>
<p>Grabbing the QuickFeather User Guide we take a look at the board I/O
diagram: <img alt="qf_pm2dot5aqi qf-board" src="../../_images/qf_pm2dot5aqi-qf-board.png" /></p>
<div class="section" id="gnd">
<h3>GND<a class="headerlink" href="#gnd" title="Permalink to this headline">¶</a></h3>
<p>How to connect the GND is obvious (use J3.1, or J3.13, or J8.16).</p>
</div>
<div class="section" id="vcc">
<h3>VCC<a class="headerlink" href="#vcc" title="Permalink to this headline">¶</a></h3>
<p>The datasheet specifies that VCC must be 5V, not 3.3V – so how are we
going to get that? Since the board is powered by USB, and the normal USB
voltage is 5V, perhaps VBAT (J2.1) is 5V? We can look at the schematic
to find out. Zooming in on J2 we find that J2.1 is connected to VBAT:
<img alt="qf_pm2dot5aqi qf-schematic-J2" src="../../_images/qf_pm2dot5aqi-qf-schematic-J2.png" /></p>
<p>And VBAT is driven by the charger:</p>
<p><img alt="qf_pm2dot5aqi qf-schematic-VBAT" src="../../_images/qf_pm2dot5aqi-qf-schematic-VBAT.png" /></p>
<p>So, it is unlikely to be 5V, more likely to be 4.2V. A quick measurement
shows it to be 4.3V on my QuickFeather. We’ll just have to see if that
is good enough, otherwise we have the tricky task of finding VBUS on the
board as soldering a wire to it.</p>
</div>
<div class="section" id="set">
<h3>SET<a class="headerlink" href="#set" title="Permalink to this headline">¶</a></h3>
<p>We want to connect this to a GPIO so that it is under software control.
However, a search of the User Guide results in no matches. So, that
means we need to go to the S3 documentation. We could go to the
datasheet, but the S3 TRM (Technical Reference Manual) has a lot more
information, so let’s use that. <img alt="qf_pm2dot5aqi s3-TRM" src="../../_images/qf_pm2dot5aqi-s3-TRM.png" /></p>
<div class="line-block">
<div class="line">Where we learn that GPIO[0] shares IO_6 (pad 6) with several other
signals.</div>
<div class="line">The table in pincfg.c is used to control which function drives the IO.</div>
<div class="line">Continuing the search, we can build the following table: |GPIO | IO
| IO | | :—: | :—: | :—: | | 0 | 6 | 24 | | 1 | 9 |
26 | |2 |11 |28| |3 |14 |30| |4 |18 |31| |5 |21 |36|
|6 |22 |38| |7 |23 |45|</div>
</div>
<p>Notice that each GPIO can drive two different pins. The table in
pincfg.c is used to select which of the two IOs is driven by the GPIO.
Now we need to understand which pins on the QuickFeather are driven by
the GPIO and if there is and conflicting function. The QuickFeather User
Guide has a useful table that helps with this:</p>
<p><img alt="qf_pm2dot5aqi qf-ug-iotable" src="../../_images/qf_pm2dot5aqi-qf-ug-iotable.png" /></p>
<p>From this we can see that GPIO0 can drive IO_6, which is connected to
the User Button and J8.10. GPIO1 can drive IO_9, but the table is silent
about IO_9 which presumably means that it has some other use. Filling
out the complete table we get: |GPIO |IO |Function |Connector |IO
|Function |Connector | | :—: | :—: | — | :—: | :—: |
— | :—: | |0 |6 |User Button |J8.10 |24 |I2S Slave DATA
|J8.4 | |1 |9 | | |26 | | | |2 |11 |IO |J8.6 |28 |PDM
Data |J8.1 | |3 |14 |SWD CLK |J6.4 |30 |IO |J3.10 | |4 |18
|Blue LED |N/A |31 |I2S Slave CLK |J8.5 | |5 |21 |Green LED
|N/A |36 |SPIM MISO |J3.4 | |6 |22 |Red LED |N/A |38 |SPIM
MOSI |J3.5 | |7 |23 |I2S Slave WCLK |J8.3 |45 |UART RX |J3.3 |</p>
<p>We need GPIO4,5 and 6 to control the LED to indicate air quality, so
those are not appropriate.</p>
<p>GPIO2 is shorted to PDM data so that is not available without modifying
the board.</p>
<p>GPIO1 does not go to a connector.</p>
<p>That leaves GPIO0/IO_24 for the SET and GPIO7/IO_23 for the RESET.</p>
<p>So now we can create our wiring table: |PMS5003 Pin|PMS5003 Function
|QuickFeather Connector |QuickFeather Function| | :—: | :—: |
:—: | — | |1 |VCC |J2.1 |VBAT | |2 |GND |J3.13 |GND |
|3 |SET |J8.4 |GPIO0 | |4 |RX |J3.2 |TX * | |5 |TX |J3.3
|RX | |6 |RESET |J8.3 |GPIO7 |</p>
<div class="line-block">
<div class="line">• Note that you must be careful with RX and TX. Does RX mean that this
pin receives, or that it expects to drive a receiver?</div>
<div class="line">In other words, do you connect RX to RX, or RX to TX.</div>
</div>
</div>
</div>
<div class="section" id="creating-the-program">
<h2>Creating the program<a class="headerlink" href="#creating-the-program" title="Permalink to this headline">¶</a></h2>
<p>Since this is a purely software app, a good starting point is
qf_helloworldsw. So, we copy that directory into a new directory called
qf_pm2dot5aqi.</p>
<div class="section" id="add">
<h3>Add<a class="headerlink" href="#add" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>pm2dot5monitortask.c</p></li>
</ul>
</div>
<div class="section" id="modify">
<h3>Modify<a class="headerlink" href="#modify" title="Permalink to this headline">¶</a></h3>
<p>If you want to see exactly what was changed and added in the code,
compare this project to qf_helloworldsw. The changed files are:</p>
<ul class="simple">
<li><p>Main.c</p></li>
<li><p>Main_dbg_cli_menu.c</p></li>
<li><p>Copy and modify qf_hardwaresetup.c</p></li>
<li><p>Pincfg_table.c</p></li>
<li><p>Fw_global_config.h</p></li>
</ul>
</div>
</div>
<div class="section" id="computing-aqi">
<h2>Computing AQI<a class="headerlink" href="#computing-aqi" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://cfpub.epa.gov/airnow/index.cfm?action=aqibasics.aqi">https://cfpub.epa.gov/airnow/index.cfm?action=aqibasics.aqi</a></p>
<p><img alt="qf_pm2dot5aqi aqi-def" src="../../_images/qf_pm2dot5aqi-aqi-def.png" /></p>
<p><img alt="qf_pm2dot5aqi aqi-normalize" src="../../_images/qf_pm2dot5aqi-aqi-normalize.png" /></p>
<div class="line-block">
<div class="line">Since these are normalized values, with 100 set as the acceptable
limit, we need to know the mapping.</div>
<div class="line">For the US the curve is defined by the EPA and can be found at
<a class="reference external" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;ved=2ahUKEwjtzK3YpJrsAhUMvJ4KHaBfD8wQFjALegQIARAC&amp;url=https%3A%2F%2Fwww.airnow.gov%2Fsites%2Fdefault%2Ffiles%2F2018-05%2Faqi-technical-assistance-document-may2016.pdf&amp;usg=AOvVaw1_iX6rgxZBBNPTdzqIn_D3">https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;ved=2ahUKEwjtzK3YpJrsAhUMvJ4KHaBfD8wQFjALegQIARAC&amp;url=https%3A%2F%2Fwww.airnow.gov%2Fsites%2Fdefault%2Ffiles%2F2018-05%2Faqi-technical-assistance-document-may2016.pdf&amp;usg=AOvVaw1_iX6rgxZBBNPTdzqIn_D3</a></div>
</div>
<p>The first part of the table is: <img alt="qf_pm2dot5aqi aqi-table" src="../../_images/qf_pm2dot5aqi-aqi-table.png" /></p>
<div class="line-block">
<div class="line">This is a piece-wise linear table, such that values from the range
0-12 are mapped onto the range 0-50, and those from the range 12 to
35.4 are mapped onto 50 to 100. The condensed table is: |PM2.5 ug/m^3
|AQI |Meaning (if less than AQI) |AQI Color |LED Color | | :—:
| :—: | — | :—: | :—: | |0 |0 | | | |</div>
<div class="line">|12 |50 |Good |Green |Green | |35.4 |100 |Moderate |Yellow
|Blue | |55.4 |150 |Unhealthy for sensitive groups |Orange |Red
| |150.4 |200 |Unhealthy |Red |Purple | |250.4 |300 |Very
Unhealthy |Purple |Purple | |500.4 |500 |Hazardous |Brown
|Purple |</div>
</div>
</div>
<div class="section" id="finished-product">
<h2>Finished product<a class="headerlink" href="#finished-product" title="Permalink to this headline">¶</a></h2>
<p>Showing green, so my indoor AQI is Good. When I take it outside, the
color switches to blue indicating Moderate air quality. So now I know
that the natural filtering effect of the house, combined with a number
of HEPA filters really helps.</p>
<p><img alt="qf_pm2dot5aqi finished-product" src="../../_images/finished-product.png" /></p>
<div class="toctree-wrapper compound">
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../ql-symbiflow/ql-symbiflow.html" class="btn btn-neutral float-right" title="QuickLogic FPGA Toolchain" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="qorc-example-apps.html" class="btn btn-neutral float-left" title="QORC Example Applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, QuickLogic Corp

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>